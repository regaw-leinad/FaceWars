<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>sandbox</title>
	<style type="text/css" media="screen">
		.point {
			width: 0;
			height: 0;
			position: absolute;
			top: 50%;
			left: 50%;
		}
		.ship {
			width: 50px;
			height: 50px;
			position: absolute;
			z-index: 10;
			top: 50%;
			left: 50%;
			margin-top: -25px;
			margin-left: -25px;
			border-radius: 100px;
			opacity: 0.6;
		}
	</style>
</head>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/script/salt.js"></script>
<script type="text/javascript">



	$(window).bind('beforeunload', function(eventObject) {
	    socket.emit(Packet.USER_DISCONNECTING, { user: currentUser });
	});


	var Packet = {
	    USER_AUTH_NEW: 0,
	    USER_AUTH_RESPONSE: 1,
	    USER_JOIN_SESSION: 2,
	    USER_LEAVE_SESSION: 3,
	    USER_DISCONNECTING: 4,
	    UPDATE_ENTITY: 5,
	    CHAT_MESSAGE: 6
	};

	var EntityType = {
		SHIP: 0,
		PROJECTILE: 1
	};



	var entitiesByID = {};
	var ownProjectilesById = {};
	var ownShipEntity;

	var currentUser = {
		id: undefined,
		name: undefined,
		color: undefined
	};

	var currentSession = {
		id: undefined,
		users: []
	};

	var entityExample = {
		userName: undefined,
		elementId: undefined,
		type: undefined,
		x: undefined,
		y: undefined,
		dx: undefined,
		dy: undefined,
		speed: undefined,
		shipRotation: undefined,
		moveRotation: undefined
	};



	var socket = io.connect('http://localhost:1234');
	//var socket = io.connect('http://iuga.ischool.uw.edu:1234');

	socket.on(Packet.USER_AUTH_RESPONSE, function (data) {
		if (data.err) {
			console.error(data.err);
			return;
		}

		currentUser = data.user;
		currentSession = data.session;

		console.log('auth success');
		console.log(currentUser);
		console.log(currentSession);

		ownShipEntity = new Ship(Ship.createNewDataFromUser(currentUser));
		entitiesByID[ownShipEntity.getId()] = ownShipEntity;

		// begin packet loop
		onFrame.oldTime = (new Date()).getTime();
		onFrame((new Date()).getTime());

	});

	socket.emit(Packet.USER_AUTH_NEW, {
		userName: salt(10),
		color: '#' + Math.floor(Math.random() * 16777215).toString(16)
	});

	socket.on(Packet.USER_JOIN_SESSION, function (data) {
		// add user to current session
		currentSession.users[data.user.id] = data.user;
	});

	socket.on(Packet.USER_LEAVE_SESSION, function (data) {
		// remove entities from DOM and reference
		Object.keys(entitiesByID).forEach(function (entityID) {
			if (entitiesByID[entityID].m.userName === data.user.name) {
				entitiesByID[entityID].remove();
				
			}
		});
		// remove user from reference
		delete currentSession.users[data.user.id];
	});

	socket.on(Packet.CHAT_MESSAGE, function(data) {
		// Display the chat message here
		// data { user: userObj, msg: '', time: timeStamp }
	});

	socket.on(Packet.UPDATE_ENTITY, function (data) {
		if (entitiesByID[data.entity.id]) {
			if (data.entity.type === EntityType.SHIP) {
				entitiesByID[data.entity.id].update(data.entity);
				if (data.entity.userName === currentUser.name) {
					// packet loop lols
					onFrame((new Date()).getTime());
				}
			}
		} else {
			entitiesByID[data.entity.id] = new Ship(data.entity);
		}
	});

	// handle frame
	var deathCount = 0;
	function onFrame(time) {
		
		var dt = time - onFrame.oldTime;
		onFrame.oldTime = time;

		if (deathCount < 25) {
			console.log(dt);
			deathCount++;
		}

		handleInput(dt);
		applyGravity(ownShipEntity, dt);

		if (ownShipEntity) {
			socket.emit(
				Packet.UPDATE_ENTITY, 
				{ entity: ownShipEntity.getModel() }
			);
		}

		Object.keys(ownProjectilesById).forEach(function (id) {
			socket.emit(
				Packet.UPDATE_ENTITY, 
				{ entity: ownProjectilesById[id].getModel() }
			);
		});

		Keys.update();
	}




	var Board = {};
	Board.width = window.innerWidth;
	Board.height = window.innerHeight;
	Board.centerX = Board.width / 2;
	Board.centerY = Board.height / 2;





	function Ship(data) {
		
		this.m = {};
		this.m.id = data.id;
		this.m.color = data.color;
		this.m.userName = data.userName;
		this.m.x = data.x;
		this.m.y = data.y;
		this.m.type = data.type;
		this.m.dx = 0;
		this.m.dy = 0;

		this.gameWidth = window.innerWidth;
		this.gameHeight = window.innerHeight;
		this.centerX = this.gameWidth / 2;
		this.centerY = this.gameHeight / 2;
		
		this.el = {};
		this.el.point = document.createElement('div');
		this.el.point.setAttribute('id', this.m.id);
		this.el.point.setAttribute('class', 'point');
		this.el.ship = document.createElement('div');
		this.el.ship.setAttribute('class', 'ship');
		this.el.ship.style.backgroundColor = this.m.color;
		
		this.el.point.appendChild(this.el.ship);
		document.body.appendChild(this.el.point);

		this.draw();

	}

	Ship.createNewDataFromUser = function (user) {
		var data = {};
		data.id = (new Date()).getTime() + '-' + salt();
		data.color = user.color;
		data.userName = user.name;
		data.x = 10;
		data.y = 10;
		data.type = EntityType.SHIP;
		return data;
	};

	Ship.prototype.draw = function () {
		this.el.point.style.left = this.m.x + 'px';
		this.el.point.style.top = this.m.y + 'px';
	};

	Ship.prototype.update = function (model) {
		this.m = model;
		this.draw();
	};

	Ship.prototype.remove = function () {
		this.el.point.parentNode.removeChild(this.el.point);
		delete entitiesByID[this.m.id];
	};

	Ship.prototype.getModel = function () {
		return this.m;
	};

	Ship.prototype.getType = function () {
		return this.m.type;
	};

	Ship.prototype.getId = function () {
		return this.m.id;
	};

	Ship.prototype.moveX = function(dx) {
		this.m.x += dx;
	};

	Ship.prototype.moveY = function(dy) {
		this.m.y += dy;
	};

	Ship.prototype.setColor = function(color) {
		this.m.color = color;
	};





	var Keys = (function () {
		// state maps { keyCode: boolean }
		var keyIsDown = {};
		var keyIsPressed = {};
		var keyPressLimbo = {};
		// handle key down
		window.addEventListener('keydown', function (e) {
			var key = e.keyCode || e.which;
			keyIsDown[key] = true;
			if (!keyPressLimbo[key]) {
				keyIsPressed[key] = true;
				keyPressLimbo[key] = true;
			}
		});
		// handle key up
		window.addEventListener('keyup', function (e) {
			var key = e.keyCode || e.which;
			if (keyIsDown[key]) {
				delete keyIsDown[key];
			}
			if (keyPressLimbo[key]) {
				delete keyPressLimbo[key];
			}
		});
		// public interface
		return {
			// update on frame
			update: function () {
				// reset presses
				keyIsPressed = {};
			},
			// state check methods
			isDown: function (keyCode) {
				return keyIsDown[keyCode];
			},
			isPressed: function (keyCode) {
				if (keyIsPressed[keyCode]) {
					delete keyIsPressed[keyCode];
					return true;
				} else {
					return false;
				}
			},
			// keycodes
			SPACEBAR: 32,
			LEFT: 37,
			UP: 38,
			RIGHT: 39,
			DOWN: 40
		};
	})();




	function handleInput(dt) {
		if (!ownShipEntity) return;
		dt = dt || 1;
		var ship = ownShipEntity;
		var speed = 0.5 * dt;
		var slowdown = 3 / 4;

		// up left
		if (Keys.isDown(Keys.UP) && Keys.isDown(Keys.LEFT)) {
			speed = speed * slowdown;
			ship.moveX(-speed);
			ship.moveY(-speed);
		}
		// up right
		else if (Keys.isDown(Keys.UP) && Keys.isDown(Keys.RIGHT)) {
			speed = speed * slowdown;
			ship.moveX(speed);
			ship.moveY(-speed);
		}
		// down left
		else if (Keys.isDown(Keys.DOWN) && Keys.isDown(Keys.LEFT)) {
			speed = speed * slowdown;
			ship.moveX(-speed);
			ship.moveY(speed);
		}
		// down right
		else if (Keys.isDown(Keys.DOWN) && Keys.isDown(Keys.RIGHT)) {
			speed = speed * slowdown;
			ship.moveX(speed);
			ship.moveY(speed);
		}
		else {
			// left
			if (Keys.isDown(Keys.LEFT)) {
				ship.moveX(-speed);
			}
			// right
			if (Keys.isDown(Keys.RIGHT)) {
				ship.moveX(speed);
			}
			// up
			if (Keys.isDown(Keys.UP)) {
				ship.moveY(-speed);
			}
			// down
			if (Keys.isDown(Keys.DOWN)) {
				ship.moveY(speed);
			}
		}
	}

	function applyGravity(entity, dt) {
		var x_d = Board.centerX - entity.m.x;
		var y_d = Board.centerY - entity.m.y;
		var x_sqr = x_d*x_d;
		var y_sqr = y_d*y_d;

		var dist = Math.sqrt(x_sqr + y_sqr);

		var pull = 1 / dist;
		//(x_d*x_d + y_d*y_d);

		//if it has already rotated, make sure to premove
		//this.preMove(delta);

		/*entity.m.dx += (
			//x_sqr*pull
			x_d*pull
		);
	    entity.m.dy += (
	    	//y_sqr*pull
	    	y_d*pull
	    );
		*/

	    entity.moveX(x_d * pull * dt);
	    entity.moveY(y_d * pull * dt);

	    if(entity.m.x === Board.centerX &&
	    	entity.m.y === Board.centerY) {
	    	entity.remove();
	    }
	}




</script>
</body>
</html>